═══════════════════════════════════════════════════════════════════════════════
DANH SÁCH TẤT CẢ CÁC CON SỐ QUAN TRỌNG TRONG DỰ ÁN STUDYQNA
═══════════════════════════════════════════════════════════════════════════════

GIẢI THÍCH CÁC THUẬT NGỮ:
───────────────────────────────────────────────────────────────────────────────
• Chunk (Đoạn văn bản): Một phần nhỏ của tài liệu được chia ra để xử lý
• Embedding (Vector hóa): Chuyển đổi văn bản thành số (vector) để máy tính hiểu
• Similarity (Độ tương đồng): Mức độ giống nhau giữa câu hỏi và chunk (0-1)
• Confidence (Độ tin cậy): Mức độ chắc chắn của câu trả lời (0-1)
• Boost (Tăng cường): Tăng điểm số để ưu tiên chunk quan trọng hơn
• Threshold (Ngưỡng): Giá trị giới hạn để quyết định hành động
• Query Type (Loại câu hỏi): Phân loại câu hỏi để xử lý phù hợp
• Context (Ngữ cảnh): Tổng hợp các chunk được gửi cho LLM để trả lời
• Reference (Tham chiếu): Liên kết từ câu trả lời về chunk gốc trong tài liệu
• Token: Đơn vị đo lường văn bản (1 token ≈ 0.75 từ tiếng Việt)

CÁC LOẠI CÂU HỎI (QUERY TYPES):
───────────────────────────────────────────────────────────────────────────────
• DOCUMENT_OVERVIEW (Tổng quan tài liệu): Hỏi về toàn bộ nội dung tài liệu
• SECTION_OVERVIEW (Tổng quan phần): Hỏi về một phần cụ thể (PHẦN X)
• DIRECT (Trực tiếp): Câu hỏi đơn giản, trả lời trực tiếp từ tài liệu
• COMPARE_SYNTHESIZE (So sánh tổng hợp): So sánh nhiều khái niệm/chủ đề
• CODE_ANALYSIS (Phân tích code): Phân tích code dựa trên kiến thức tài liệu
• EXERCISE_GENERATION (Tạo bài tập): Tạo code/bài tập mới dựa trên tài liệu
• MULTI_CONCEPT_REASONING (Lý luận đa khái niệm): Kết hợp nhiều khái niệm để trả lời
• EXPAND (Mở rộng): Liệt kê hoặc giải thích chi tiết
• EXISTENCE (Tồn tại): Kiểm tra xem có đề cập đến chủ đề không
• FALLBACK (Dự phòng): Không tìm thấy thông tin, trả lời mặc định
• TOO_BROAD (Quá rộng): Câu hỏi quá chung chung, cần cụ thể hơn

═══════════════════════════════════════════════════════════════════════════════
1. UPLOAD & XỬ LÝ FILE (Tải lên và xử lý file)
═══════════════════════════════════════════════════════════════════════════════

1.1. Validation File (Kiểm tra file)
───────────────────────────────────────────────────────────────────────────────
• Số loại file được hỗ trợ: 4 loại (pdf, docx, md, txt)
  - File: backend/app/routers/documents.py, dòng 57
  - Ý nghĩa: Chỉ chấp nhận 4 định dạng file này, từ chối các loại khác

1.2. Chunking Parameters (Tham số chia nhỏ)
───────────────────────────────────────────────────────────────────────────────
• chunk_size = 800 (ký tự)
  - File: backend/app/routers/documents.py, dòng 81
  - Ý nghĩa: Kích thước mục tiêu của mỗi chunk là 800 ký tự
  - Lý do: Tăng từ 500 lên 800 để giữ nguyên nội dung trang tốt hơn

• chunk_overlap = 100 (ký tự)
  - File: backend/app/routers/documents.py, dòng 81
  - Ý nghĩa: Số ký tự trùng lặp giữa các chunk liền kề là 100
  - Lý do: Đảm bảo ngữ cảnh không bị mất khi chia nhỏ

• split_threshold = 1200 (ký tự)
  - File: backend/app/services/parser.py, dòng 512
  - Công thức: chunk_size * 1.5 = 800 * 1.5 = 1200
  - Ý nghĩa: Chỉ chia nhỏ chunk nếu độ dài vượt quá 1200 ký tự

• min_chunk_size = 100 (ký tự)
  - File: backend/app/services/parser.py, dòng 513
  - Ý nghĩa: Kích thước tối thiểu của một sub-chunk sau khi chia

• content_preview = 200 (ký tự)
  - File: backend/app/routers/documents.py, dòng 86
  - Ý nghĩa: Lấy 200 ký tự đầu tiên của chunk đầu tiên làm preview

1.3. Heading Detection (Phát hiện tiêu đề)
───────────────────────────────────────────────────────────────────────────────
• Concept heading threshold = 80 (ký tự)
  - File: backend/app/services/parser.py, dòng 98
  - Ý nghĩa: Dòng ngắn hơn 80 ký tự có thể là concept heading

• Concept heading word limit = 5 (từ)
  - File: backend/app/services/parser.py, dòng 100, 105
  - Ý nghĩa: Concept heading thường có ≤ 5 từ

• Heading extraction threshold = 100 (ký tự)
  - File: backend/app/services/rag.py, dòng 2408
  - Ý nghĩa: Nếu content < 100 ký tự và có vẻ là heading → coi là heading

2. EMBEDDING & LƯU TRỮ VECTOR (Vector hóa và lưu trữ)
═══════════════════════════════════════════════════════════════════════════════

2.1. Embedding Model (Mô hình vector hóa)
───────────────────────────────────────────────────────────────────────────────
• Embedding dimension = 384 (số chiều vector)
  - File: backend/app/services/embedding.py, dòng 131
  - Model: sentence-transformers/all-MiniLM-L6-v2
  - Ý nghĩa: Mỗi vector embedding có 384 chiều (384 số thực)
  - Giải thích: Vector 384 chiều là một mảng gồm 384 số, mỗi số đại diện cho một đặc trưng của văn bản
  - Ví dụ: [0.12, -0.45, 0.78, ..., 0.23] (384 số)

• embedding_batch_size = 32 (văn bản)
  - File: backend/app/core/config.py, dòng 20
  - File: backend/app/services/embedding.py, dòng 20
  - Ý nghĩa: Xử lý 32 văn bản cùng lúc khi tạo embedding
  - Lý do: Xử lý theo batch (lô) nhanh hơn và hiệu quả hơn xử lý từng cái một

3. TRUY VẤN (QUERY) - Tìm kiếm và xử lý câu hỏi
═══════════════════════════════════════════════════════════════════════════════

3.1. Document Limits (Giới hạn số tài liệu)
───────────────────────────────────────────────────────────────────────────────
• Tối đa documents được chọn: 5 (files)
  - File: backend/app/routers/query.py, dòng 78
  - Ý nghĩa: Chỉ cho phép chọn tối đa 5 tài liệu cùng lúc để tránh overload

• Tối thiểu documents: 1 (file)
  - File: backend/app/routers/query.py, dòng 71
  - Ý nghĩa: Phải chọn ít nhất 1 tài liệu để hỏi

3.2. Max Chunks per Query Type (Số chunk tối đa theo loại câu hỏi - Giá trị cơ bản)
───────────────────────────────────────────────────────────────────────────────
• DOCUMENT_OVERVIEW (Tổng quan tài liệu): base = 150 chunks
  - File: backend/app/services/rag.py, dòng 992
  - Với 2 files: 150 * 1.5 = 225 chunks
  - Với 3+ files: 150 * 2.0 = 300 chunks
  - Ý nghĩa: Cần nhiều chunks nhất để quét toàn bộ tài liệu
  - Giải thích: Câu hỏi "tài liệu có bao nhiêu phần?" cần xem nhiều chunk để tìm tất cả các phần

• SECTION_OVERVIEW (Tổng quan phần): base = 45 chunks
  - File: backend/app/services/rag.py, dòng 997
  - Với 2 files: 45 * 1.5 = 67 chunks
  - Với 3+ files: 45 * 2.0 = 90 chunks
  - Ý nghĩa: Cần số chunk vừa phải để tìm nội dung của một phần cụ thể
  - Giải thích: Câu hỏi "PHẦN 8 nói gì?" cần tìm các chunk liên quan đến PHẦN 8

• MULTI_CONCEPT_REASONING (Lý luận đa khái niệm):
  - File: backend/app/services/rag.py, dòng 1001-1016
  - Nếu có ≥3 concepts (khái niệm): base = 30 chunks
  - Nếu có 2 concepts: base = 25 chunks
  - Nếu có 1 concept: base = 20 chunks
  - Ý nghĩa: Cần nhiều chunk hơn nếu câu hỏi liên quan đến nhiều khái niệm
  - Giải thích: Câu hỏi "dựa trên scope và closure, giải thích..." cần tìm chunk về cả 2 khái niệm

• CODE_ANALYSIS (Phân tích code): base = 20-30 chunks (tùy số concepts)
  - File: backend/app/services/rag.py, dòng 1001-1016
  - Ý nghĩa: Cần chunk về các khái niệm liên quan đến code cần phân tích

• EXERCISE_GENERATION (Tạo bài tập): base = 20-30 chunks (tùy số concepts)
  - File: backend/app/services/rag.py, dòng 1001-1016
  - Ý nghĩa: Cần chunk về các khái niệm để tạo bài tập mới

• COMPARE_SYNTHESIZE (So sánh tổng hợp): base = 30-35 chunks
  - File: backend/app/services/rag.py, dòng 1019-1025
  - Nếu so sánh 2+ items (mục): base = 35 chunks
  - Nếu không: base = 30 chunks
  - Ý nghĩa: Cần nhiều chunk để tìm thông tin về tất cả các mục cần so sánh
  - Giải thích: Câu hỏi "so sánh var và let" cần chunk về cả var và let

• EXPAND (Mở rộng/liệt kê): base = 20 chunks
  - File: backend/app/services/rag.py, dòng 1028-1030
  - Ý nghĩa: Câu hỏi "liệt kê tất cả..." cần chunk để tìm tất cả các mục

• DIRECT (Trực tiếp): base = 15 chunks
  - File: backend/app/services/rag.py, dòng 1033
  - Ý nghĩa: Câu hỏi đơn giản chỉ cần ít chunk để trả lời trực tiếp

3.3. Multi-Document Multipliers (Hệ số nhân cho nhiều tài liệu)
───────────────────────────────────────────────────────────────────────────────
• 1 file: multiplier = 1.0x (hệ số nhân = 1.0)
  - Ý nghĩa: Không nhân thêm, dùng giá trị base
• 2 files: multiplier = 1.5x (hệ số nhân = 1.5)
  - Ý nghĩa: Nhân base với 1.5 để có đủ chunk từ 2 tài liệu
• 3+ files: multiplier = 2.0x (hệ số nhân = 2.0)
  - Ý nghĩa: Nhân base với 2.0 để có đủ chunk từ nhiều tài liệu
  - File: backend/app/services/rag.py, dòng 985-990
  - Giải thích: Càng nhiều tài liệu thì cần càng nhiều chunk để tìm thông tin từ tất cả

3.4. Vector Search (Tìm kiếm vector - search_k)
───────────────────────────────────────────────────────────────────────────────
• search_k: Số lượng vector lân cận nhất cần tìm trong FAISS (cơ sở dữ liệu vector)
• DOCUMENT_OVERVIEW (Tổng quan tài liệu): search_k = 150
  - File: backend/app/services/rag.py, dòng 1840
  - Ý nghĩa: Tìm 150 vector lân cận nhất trong FAISS
  - Giải thích: Cần tìm nhiều vector để quét toàn bộ tài liệu

• SECTION_OVERVIEW (Tổng quan phần): search_k = 100
  - File: backend/app/services/rag.py, dòng 1843
  - Ý nghĩa: Tìm 100 vector lân cận nhất

• COMPARE_SYNTHESIZE (So sánh tổng hợp): search_k = 75
  - File: backend/app/services/rag.py, dòng 1847
  - Ý nghĩa: Tìm 75 vector lân cận nhất

• MULTI_CONCEPT_REASONING (Lý luận đa khái niệm), CODE_ANALYSIS (Phân tích code): search_k = 50
  - File: backend/app/services/rag.py, dòng 1849
  - Ý nghĩa: Tìm 50 vector lân cận nhất

• Các loại khác: search_k = 30
  - File: backend/app/services/rag.py, dòng 1851
  - Ý nghĩa: Tìm 30 vector lân cận nhất cho câu hỏi đơn giản

3.5. Similarity Calculation (Tính toán độ tương đồng)
───────────────────────────────────────────────────────────────────────────────
• Công thức: similarity = 1.0 / (1.0 + distance)
  - File: backend/app/services/rag.py, dòng 1865
  - Ý nghĩa: Chuyển đổi khoảng cách (distance) thành độ tương đồng (0-1)
  - Giải thích: 
    * distance (khoảng cách): Càng nhỏ = càng giống nhau
    * similarity (độ tương đồng): Càng lớn = càng giống nhau (0 = không giống, 1 = giống hệt)
    * Ví dụ: distance = 0.5 → similarity = 1.0 / (1.0 + 0.5) = 0.67 (67% giống nhau)

3.6. Boosting Values (Giá trị tăng cường - ưu tiên chunk quan trọng)
───────────────────────────────────────────────────────────────────────────────
• Boost: Tăng điểm số (similarity) để ưu tiên chunk quan trọng hơn
• Main section boost (Tăng cường tiêu đề chính): +0.5
  - File: backend/app/services/rag.py, dòng 2018
  - Ý nghĩa: Tăng độ tương đồng thêm 0.5 cho chunk là tiêu đề chính (PHẦN X, CHƯƠNG X)
  - Ví dụ: similarity = 0.6 → sau boost = 0.6 + 0.5 = 1.0 (nhưng bị giới hạn ở 1.0)

• Section number match (Khớp số phần): +3 (keyword_matches)
  - File: backend/app/services/rag.py, dòng 2056
  - Ý nghĩa: Nếu tìm thấy số phần trong câu hỏi khớp với content (ví dụ: hỏi "PHẦN 8" và chunk có "PHẦN 8")
  - Giải thích: Tăng keyword_matches thêm 3, sau đó dùng công thức boost

• Subsection match (Khớp tiểu mục): +8 (keyword_matches)
  - File: backend/app/services/rag.py, dòng 2072
  - Ý nghĩa: Nếu tìm thấy subsection (ví dụ: 8.1) khớp với content
  - Giải thích: Khớp chính xác subsection được ưu tiên cao hơn (8 điểm vs 3 điểm)

• Quoted terms weight (Trọng số từ khóa trong ngoặc kép): x3
  - File: backend/app/services/rag.py, dòng 2037
  - Ý nghĩa: Từ khóa trong dấu ngoặc kép có trọng số gấp 3 lần
  - Ví dụ: Câu hỏi có "module" → tìm "module" trong content được tính 3 lần

• Keyword boost formula (Công thức tăng cường từ khóa): min(0.3, keyword_matches * 0.08)
  - File: backend/app/services/rag.py, dòng 2083
  - Ý nghĩa: Boost tối đa 0.3, mỗi keyword match thêm 0.08
  - Ví dụ: 5 keyword matches → boost = min(0.3, 5 * 0.08) = min(0.3, 0.4) = 0.3

• Table of Contents boost (Tăng cường mục lục): +0.8
  - File: backend/app/services/rag.py, dòng 2097
  - Ý nghĩa: Chunk chứa "MỤC LỤC" được boost thêm 0.8
  - Giải thích: Mục lục rất quan trọng cho câu hỏi tổng quan

• Overview boost (Tăng cường tổng quan): min(0.6, section_count * 0.15)
  - File: backend/app/services/rag.py, dòng 2106
  - Điều kiện: Chunk chứa ≥3 "PHẦN X"
  - Ý nghĩa: Boost tối đa 0.6, mỗi section thêm 0.15
  - Ví dụ: Chunk có 5 "PHẦN X" → boost = min(0.6, 5 * 0.15) = min(0.6, 0.75) = 0.6

• Max similarity after boost (Độ tương đồng tối đa sau boost): 1.0
  - File: backend/app/services/rag.py, dòng 2112
  - Ý nghĩa: Độ tương đồng sau boost không vượt quá 1.0 (100% giống nhau)
  - Giải thích: Dù boost bao nhiêu, similarity không thể > 1.0

3.7. Priority Chunks Threshold (Ngưỡng chunk ưu tiên)
───────────────────────────────────────────────────────────────────────────────
• Concept match similarity threshold (Ngưỡng độ tương đồng khi khớp khái niệm): > 0.4
  - File: backend/app/services/rag.py, dòng 2171
  - Ý nghĩa: Chunk có concept match (khớp khái niệm) và similarity > 0.4 → priority (ưu tiên)
  - Giải thích: Chunk có chứa khái niệm liên quan và độ tương đồng > 40% sẽ được ưu tiên chọn trước

3.8. Context Length Limits (Giới hạn độ dài ngữ cảnh)
───────────────────────────────────────────────────────────────────────────────
• Context (Ngữ cảnh): Tổng hợp tất cả các chunk được gửi cho LLM để trả lời câu hỏi
• DOCUMENT_OVERVIEW (Tổng quan tài liệu - 1 file): 50,000 ký tự
  - File: backend/app/services/rag.py, dòng 2235
  - Ý nghĩa: Cho phép gửi tối đa 50,000 ký tự cho LLM
  - Giải thích: Câu hỏi tổng quan cần nhiều thông tin nên giới hạn cao hơn

• DOCUMENT_OVERVIEW (Tổng quan tài liệu - 2 files): 55,000 ký tự
  - File: backend/app/services/rag.py, dòng 2233
  - Ý nghĩa: 2 tài liệu cần nhiều ngữ cảnh hơn 1 tài liệu

• DOCUMENT_OVERVIEW (Tổng quan tài liệu - 3+ files): 60,000 ký tự
  - File: backend/app/services/rag.py, dòng 2231
  - Ý nghĩa: 3+ tài liệu cần ngữ cảnh nhiều nhất

• Các query type khác: 12,000 ký tự
  - File: backend/app/services/rag.py, dòng 915, 2238
  - Công thức: min(12000, settings.rag_max_context_length)
  - settings.rag_max_context_length = 20,000 (File: backend/app/core/config.py, dòng 25)
  - Ý nghĩa: Câu hỏi thông thường chỉ cần 12,000 ký tự ngữ cảnh
  - Giải thích: Lấy giá trị nhỏ hơn giữa 12,000 và 20,000 → kết quả là 12,000

• Context threshold (Ngưỡng ngữ cảnh) cho DOCUMENT_OVERVIEW:
  - Multi-doc (Nhiều tài liệu): context_limit * 1.20 = 120% (cho phép vượt 20%)
  - Single-doc (Một tài liệu): context_limit * 1.05 = 105% (cho phép vượt 5%)
  - File: backend/app/services/rag.py, dòng 2349, 2352
  - Giải thích: Cho phép vượt quá giới hạn một chút để đảm bảo có đủ thông tin

• Buffer khi check context (Vùng đệm khi kiểm tra ngữ cảnh): +500 ký tự
  - File: backend/app/services/rag.py, dòng 2359, 2363
  - Ý nghĩa: Dự trữ 500 ký tự khi kiểm tra giới hạn
  - Giải thích: Khi tính toán, cộng thêm 500 ký tự để đảm bảo không vượt quá giới hạn

3.9. Multi-Doc Balancing (Cân bằng đa tài liệu)
───────────────────────────────────────────────────────────────────────────────
• chunks_per_doc (Số chunk mỗi tài liệu) = max(40, int(max_selected_chunks * 0.6))
  - File: backend/app/services/rag.py, dòng 2254
  - Ý nghĩa: Chọn ít nhất 40 chunks từ mỗi document, hoặc 60% của max_selected_chunks
  - Giải thích: Đảm bảo mỗi tài liệu đều có đại diện trong kết quả, không bị lệch về một tài liệu
  - Ví dụ: max_selected_chunks = 150 → chunks_per_doc = max(40, 150 * 0.6) = max(40, 90) = 90

4. SINH CÂU TRẢ LỜI (LLM - Large Language Model)
═══════════════════════════════════════════════════════════════════════════════

4.1. Similarity Thresholds (Ngưỡng độ tương đồng)
───────────────────────────────────────────────────────────────────────────────
• similarity_threshold: Ngưỡng độ tương đồng tối thiểu để coi là có thông tin liên quan
• DOCUMENT_OVERVIEW (Tổng quan tài liệu): similarity_threshold = 0.25
  - File: backend/app/services/rag.py, dòng 267
  - Ý nghĩa: Nếu max_similarity (độ tương đồng cao nhất) < 0.25 → warning FALLBACK
  - Giải thích: Câu hỏi tổng quan chấp nhận độ tương đồng thấp hơn (25%) vì cần quét toàn bộ

• Các query type khác: similarity_threshold = 0.4
  - File: backend/app/services/rag.py, dòng 269
  - File: backend/app/core/config.py, dòng 28 (rag_low_similarity_threshold = 0.4)
  - Ý nghĩa: Nếu max_similarity < 0.4 (40%) → warning FALLBACK
  - Giải thích: Câu hỏi cụ thể cần độ tương đồng cao hơn (40%) để đảm bảo có thông tin chính xác

4.2. LLM Configuration (Cấu hình mô hình ngôn ngữ lớn)
───────────────────────────────────────────────────────────────────────────────
• temperature (Nhiệt độ) = 0.0
  - File: backend/app/services/rag.py, dòng 3286
  - Ý nghĩa: Đảm bảo câu trả lời nhất quán, ít sáng tạo
  - Giải thích: temperature = 0.0 → LLM trả lời chính xác, không tạo thêm nội dung ngẫu nhiên
  - Range: 0.0 (chính xác) đến 1.0 (sáng tạo)

• maxOutputTokens (Token đầu ra tối đa) = 12,000 (tokens)
  - File: backend/app/services/rag.py, dòng 919, 3290
  - Ý nghĩa: Giới hạn token đầu ra là 12,000 (~9,000-10,000 từ tiếng Việt)
  - Giải thích: 1 token tiếng Việt ≈ 0.75 từ, nên 12,000 tokens ≈ 9,000-10,000 từ

• candidateCount (Số lượng ứng viên) = 1
  - File: backend/app/services/rag.py, dòng 3291
  - Ý nghĩa: Chỉ lấy 1 câu trả lời từ LLM
  - Giải thích: Không cần nhiều phiên bản, chỉ cần 1 câu trả lời tốt nhất

• llm_max_tokens = 2,048 (không dùng cho Gemini)
  - File: backend/app/core/config.py, dòng 24
  - Ý nghĩa: Cấu hình cũ, không áp dụng cho Gemini
  - Giải thích: Dùng cho OpenAI, nhưng dự án này dùng Gemini nên không áp dụng

4.3. Confidence Values by Query Type (Giá trị độ tin cậy theo loại câu hỏi)
───────────────────────────────────────────────────────────────────────────────
• Confidence (Độ tin cậy): Mức độ chắc chắn của câu trả lời (0.0 = không chắc, 1.0 = rất chắc)
• DOCUMENT_OVERVIEW (Tổng quan tài liệu):
  - Có TOC (Mục lục) và đầy đủ sections (phần): 0.95 (95% chắc chắn)
  - Có sections nhưng không có TOC: 0.85 (85% chắc chắn)
  - Thiếu một số sections: 0.70 (70% chắc chắn)
  - File: backend/app/services/rag.py, dòng 386
  - Giải thích: Có mục lục đầy đủ → độ tin cậy cao nhất

• CODE_ANALYSIS (Phân tích code): 0.75-0.85 (75-85% chắc chắn)
  - File: backend/app/services/rag.py, dòng 445
  - Giải thích: Phân tích code cần suy luận nên độ tin cậy trung bình

• EXERCISE_GENERATION (Tạo bài tập): 0.8-0.9 (80-90% chắc chắn)
  - File: backend/app/services/rag.py, dòng 489
  - Giải thích: Tạo bài tập dựa trên tài liệu nên độ tin cậy khá cao

• MULTI_CONCEPT_REASONING (Lý luận đa khái niệm): 0.7-0.85 (70-85% chắc chắn)
  - File: backend/app/services/rag.py, dòng 526
  - Giải thích: Cần kết hợp nhiều khái niệm nên độ tin cậy thấp hơn

• COMPARE_SYNTHESIZE (So sánh tổng hợp): 0.8-0.95 (80-95% chắc chắn)
  - File: backend/app/services/rag.py, dòng 606
  - Giải thích: So sánh có thể rất chính xác nếu tìm đủ thông tin

• DIRECT (Trực tiếp): 0.90 (90% chắc chắn)
  - File: backend/app/services/rag.py, dòng 694
  - Giải thích: Câu hỏi đơn giản, trả lời trực tiếp từ tài liệu nên độ tin cậy cao

• FALLBACK (Dự phòng): 0.0 (0% chắc chắn)
  - File: backend/app/services/rag.py, dòng 892
  - Giải thích: Không tìm thấy thông tin nên không có độ tin cậy

• SECTION_OVERVIEW (Tổng quan phần - reconstructed/tái tạo): 0.75 nếu có chunks, 0.5 nếu không
  - File: backend/app/services/rag.py, dòng 1517
  - Giải thích: Nếu có chunks được sử dụng → 75% chắc, không có → 50% chắc

• COMPARE_SYNTHESIZE (So sánh tổng hợp - reconstructed): 0.85 nếu có bảng, 0.75 nếu không
  - File: backend/app/services/rag.py, dòng 1521
  - Giải thích: Có bảng so sánh → độ tin cậy cao hơn (85% vs 75%)

4.4. Confidence Thresholds (Ngưỡng độ tin cậy)
───────────────────────────────────────────────────────────────────────────────
• rag_low_confidence_threshold (Ngưỡng độ tin cậy thấp) = 0.3
  - File: backend/app/core/config.py, dòng 29
  - Ý nghĩa: Nếu confidence < 0.3 (30%) → có thể ép buộc FALLBACK
  - Giải thích: Độ tin cậy quá thấp (< 30%) → không đáng tin, nên trả về FALLBACK

• Auto-correction thresholds (Ngưỡng tự động điều chỉnh):
  - Answer length > 1000 chars (độ dài câu trả lời > 1000 ký tự): confidence = 0.85
  - Answer length > 700 chars: confidence = 0.80
  - Answer length > 500 chars: confidence = 0.75
  - File: backend/app/services/rag.py, dòng 3530-3535, 3574-3579
  - Giải thích: Câu trả lời dài thường có chất lượng tốt → tự động tăng confidence

• Reasoning query confidence threshold (Ngưỡng độ tin cậy cho câu hỏi lý luận): 0.4
  - File: backend/app/services/rag.py, dòng 3481
  - Ý nghĩa: Nếu confidence < 0.4 (40%) cho reasoning query → FALLBACK
  - Giải thích: Câu hỏi lý luận cần độ tin cậy cao hơn (40% thay vì 30%)

• SECTION_OVERVIEW validation (Kiểm tra tổng quan phần):
  - Nếu confidence < 0.7 nhưng có chunks và content → boost lên 0.85
  - File: backend/app/services/rag.py, dòng 3597-3598
  - Giải thích: Nếu có chunks được sử dụng và nội dung đầy đủ → tăng confidence

• DOCUMENT_OVERVIEW validation (Kiểm tra tổng quan tài liệu):
  - Nếu confidence < 0.8 nhưng có chunks và content > 200 chars → boost lên 0.85
  - File: backend/app/services/rag.py, dòng 3615-3616
  - Giải thích: Nếu có chunks và nội dung > 200 ký tự → tăng confidence

• Confidence-Chunks Paradox threshold (Ngưỡng nghịch lý độ tin cậy-chunks): 0.7
  - File: backend/app/services/rag.py, dòng 3683
  - Ý nghĩa: Nếu confidence > 0.7 (70%) nhưng chunks = 0 → nghi ngờ
  - Giải thích: Nghịch lý: độ tin cậy cao nhưng không có chunk nào được dùng → có thể là synthesis hoặc fallback

4.5. Answer Length Validation (Kiểm tra độ dài câu trả lời)
───────────────────────────────────────────────────────────────────────────────
• Reasoning query minimum (Tối thiểu cho câu hỏi lý luận): 50 ký tự
  - File: backend/app/services/rag.py, dòng 3476
  - Ý nghĩa: Nếu < 50 ký tự → FALLBACK
  - Giải thích: Câu trả lời lý luận cần đủ dài để giải thích, nếu quá ngắn → không đủ thông tin

• Good answer threshold (Ngưỡng câu trả lời tốt): 500 ký tự
  - File: backend/app/services/rag.py, dòng 3504, 3549
  - Ý nghĩa: Câu trả lời > 500 ký tự được coi là có chất lượng tốt
  - Giải thích: Câu trả lời dài thường có đủ thông tin và chi tiết

• SECTION_OVERVIEW minimum (Tối thiểu tổng quan phần): 50 ký tự
  - File: backend/app/services/rag.py, dòng 3606
  - Ý nghĩa: Nếu < 50 ký tự → FALLBACK
  - Giải thích: Tổng quan phần cần ít nhất 50 ký tự để có nội dung

• SECTION_OVERVIEW expected (Kỳ vọng tổng quan phần): > 100 ký tự
  - File: backend/app/services/rag.py, dòng 3592
  - Ý nghĩa: Câu trả lời tổng quan phần nên > 100 ký tự
  - Giải thích: Độ dài kỳ vọng để có đủ thông tin về một phần

• DOCUMENT_OVERVIEW minimum (Tối thiểu tổng quan tài liệu): 100 ký tự
  - File: backend/app/services/rag.py, dòng 3618
  - Ý nghĩa: Nếu < 100 ký tự → FALLBACK
  - Giải thích: Tổng quan tài liệu cần nhiều thông tin hơn (100 ký tự)

• DOCUMENT_OVERVIEW expected (Kỳ vọng tổng quan tài liệu): > 200 ký tự
  - File: backend/app/services/rag.py, dòng 3614
  - Ý nghĩa: Câu trả lời tổng quan tài liệu nên > 200 ký tự
  - Giải thích: Tổng quan toàn bộ tài liệu cần nhiều thông tin hơn (200 ký tự)

• Substantial synthesis answer (Câu trả lời tổng hợp đáng kể): ≥ 4000 ký tự
  - File: backend/app/services/rag.py, dòng 3655
  - Ý nghĩa: Câu trả lời ≥ 4000 ký tự được coi là synthesis tốt
  - Giải thích: Câu trả lời rất dài (≥ 4000 ký tự) thường là tổng hợp tốt từ nhiều nguồn

• Paradox detection threshold (Ngưỡng phát hiện nghịch lý): ≥ 2000 ký tự
  - File: backend/app/services/rag.py, dòng 3687
  - Ý nghĩa: Nếu answer ≥ 2000 ký tự nhưng chunks = 0 → mark as SYNTHESIS
  - Giải thích: Câu trả lời dài nhưng không có chunk → có thể là tổng hợp từ kiến thức chung

4.6. Chunk Extraction Limits (Giới hạn trích xuất chunk)
───────────────────────────────────────────────────────────────────────────────
• Max chunks extracted from answer text (Tối đa chunks trích xuất từ câu trả lời): 15 chunks
  - File: backend/app/services/rag.py, dòng 3511, 3556
  - Ý nghĩa: Tối đa 15 chunks được trích xuất từ câu trả lời
  - Giải thích: Tìm các số chunk được đề cập trong câu trả lời (ví dụ: "chunk 5", "chunk 12")

• Max chunks after merge (Tối đa chunks sau khi gộp): 20 chunks
  - File: backend/app/services/rag.py, dòng 3519, 3564
  - Ý nghĩa: Giới hạn tổng số chunks sau khi merge (gộp chunks từ nhiều nguồn)
  - Giải thích: Sau khi gộp chunks từ LLM và chunks trích xuất từ text → giới hạn ở 20

• Max chunks in reconstructed JSON (Tối đa chunks trong JSON tái tạo): 15 chunks
  - File: backend/app/services/rag.py, dòng 1630, 1633
  - Ý nghĩa: Khi tái tạo JSON từ văn bản thuần túy, giới hạn 15 chunks
  - Giải thích: Nếu LLM không trả về JSON hợp lệ, tái tạo từ text và giới hạn 15 chunks

4.7. Sentence Mapping (Ánh xạ câu)
───────────────────────────────────────────────────────────────────────────────
• Sentence Mapping: Liên kết mỗi câu trong câu trả lời với chunk gốc trong tài liệu
• Min sentence length (Độ dài câu tối thiểu): 10 ký tự
  - File: backend/app/services/rag.py, dòng 1588
  - Ý nghĩa: Bỏ qua các câu ngắn hơn 10 ký tự
  - Giải thích: Câu quá ngắn không đủ thông tin để ánh xạ

• Sentence preview length (Độ dài xem trước câu): 200 ký tự
  - File: backend/app/services/rag.py, dòng 1620
  - Ý nghĩa: Mỗi sentence trong mapping chỉ lưu 200 ký tự đầu
  - Giải thích: Không cần lưu toàn bộ câu, chỉ cần 200 ký tự đầu để nhận diện

• External sentence threshold (Ngưỡng câu ngoài tài liệu): > 50%
  - File: backend/app/services/rag.py, dòng 3652
  - Ý nghĩa: Nếu > 50% sentences là external (không từ tài liệu) → có thể là FALLBACK
  - Giải thích: Nếu hơn nửa số câu không liên kết với chunk nào → có thể là kiến thức chung, không từ tài liệu

4.8. Table Detection (Phát hiện bảng)
───────────────────────────────────────────────────────────────────────────────
• Table Detection: Phát hiện và xử lý bảng markdown trong câu trả lời
• Table max length (Độ dài tối đa bảng): 10,000 ký tự
  - File: backend/app/services/rag.py, dòng 1555
  - Ý nghĩa: Nếu table > 10,000 ký tự → cắt bớt
  - Giải thích: Bảng quá dài có thể gây lỗi, cần cắt bớt

• Table minimum length (Độ dài tối thiểu bảng): 500 ký tự
  - File: backend/app/services/rag.py, dòng 1564
  - Ý nghĩa: Khi tìm điểm kết thúc table, phải > 500 ký tự
  - Giải thích: Đảm bảo bảng có đủ nội dung (ít nhất 500 ký tự) trước khi cắt

• Non-table answer limit (Giới hạn câu trả lời không phải bảng): 2,000 ký tự
  - File: backend/app/services/rag.py, dòng 1576
  - Ý nghĩa: Câu trả lời không phải table giới hạn 2,000 ký tự
  - Giải thích: Câu trả lời thông thường không cần quá dài, giới hạn ở 2,000 ký tự

5. REFERENCES & OUTPUT (Tham chiếu và đầu ra)
═══════════════════════════════════════════════════════════════════════════════

5.1. Max References (Số tham chiếu tối đa)
───────────────────────────────────────────────────────────────────────────────
• Reference (Tham chiếu): Liên kết từ câu trả lời về chunk gốc trong tài liệu (hiển thị cho user)
• DOCUMENT_OVERVIEW (Tổng quan tài liệu): 10 references
  - File: backend/app/services/rag.py, dòng 3107
  - Ý nghĩa: Giữ tối đa 10 references cho DOCUMENT_OVERVIEW
  - Giải thích: Câu hỏi tổng quan cần nhiều tham chiếu để user xem các phần khác nhau

• Các query type khác: 5 references
  - File: backend/app/services/rag.py, dòng 3109
  - File: backend/app/core/config.py, dòng 31 (rag_max_references = 5)
  - Ý nghĩa: Câu hỏi thông thường chỉ cần 5 tham chiếu

• Dynamic max references based on chunks used (Tham chiếu động dựa trên chunks đã dùng):
  - Nếu chunks_used ≥ 5: max_refs = 5 (tối đa 5 tham chiếu)
  - Nếu chunks_used ≥ 3: max_refs = 4 (tối đa 4 tham chiếu)
  - Nếu chunks_used < 3: max_refs = 2 (tối đa 2 tham chiếu)
  - File: backend/app/services/rag.py, dòng 3959-3964
  - Giải thích: Số tham chiếu phụ thuộc vào số chunks thực sự được sử dụng

5.2. Content Preview (Xem trước nội dung)
───────────────────────────────────────────────────────────────────────────────
• Reference preview length (Độ dài xem trước tham chiếu): 160 ký tự
  - File: backend/app/services/rag.py, dòng 3929
  - Ý nghĩa: Mỗi reference chỉ hiển thị 160 ký tự đầu của content
  - Giải thích: Không cần hiển thị toàn bộ chunk, chỉ cần 160 ký tự đầu để user biết nội dung

5.3. Section Filtering (Lọc theo phần)
───────────────────────────────────────────────────────────────────────────────
• Top 2 sections kept (Giữ 2 phần hàng đầu)
  - File: backend/app/services/rag.py, dòng 3095-3100
  - Ý nghĩa: Chỉ giữ references từ 2 sections có nhiều chunks nhất
  - Giải thích: Nếu có nhiều sections, chỉ giữ 2 sections quan trọng nhất để tránh quá nhiều tham chiếu

6. HISTORY & LOGGING (Lịch sử và ghi log)
═══════════════════════════════════════════════════════════════════════════════

6.1. History Limits (Giới hạn lịch sử)
───────────────────────────────────────────────────────────────────────────────
• History (Lịch sử): Lưu trữ các câu hỏi và câu trả lời trước đó
• History limit default (Giới hạn mặc định): 20 records (bản ghi)
  - File: backend/app/routers/query.py, dòng 123
  - Ý nghĩa: Mặc định lấy 20 bản ghi lịch sử
  - Giải thích: Khi user xem lịch sử, mặc định hiển thị 20 câu hỏi gần nhất

• History limit max (Giới hạn tối đa): 100 records
  - File: backend/app/routers/query.py, dòng 130
  - Ý nghĩa: Tối đa 100 bản ghi lịch sử
  - Giải thích: Không cho phép lấy quá 100 bản ghi để tránh quá tải

• History limit min (Giới hạn tối thiểu): 1 record
  - File: backend/app/routers/query.py, dòng 130
  - Ý nghĩa: Tối thiểu 1 bản ghi
  - Giải thích: Phải lấy ít nhất 1 bản ghi

6.2. Logging (Ghi log)
───────────────────────────────────────────────────────────────────────────────
• Logging: Ghi lại thông tin để debug và theo dõi
• Question preview in log (Xem trước câu hỏi trong log): 100 ký tự
  - File: backend/app/services/rag.py, dòng 3128
  - Ý nghĩa: Chỉ log 100 ký tự đầu của câu hỏi
  - Giải thích: Không cần log toàn bộ câu hỏi, chỉ cần 100 ký tự đầu để nhận diện

• Answer preview in log (Xem trước câu trả lời trong log): 100 ký tự
  - File: backend/app/services/rag.py, dòng 3155
  - Ý nghĩa: Chỉ log 100 ký tự đầu của câu trả lời
  - Giải thích: Câu trả lời có thể rất dài, chỉ log 100 ký tự đầu để tiết kiệm dung lượng

7. KEYWORD EXTRACTION (Trích xuất từ khóa)
═══════════════════════════════════════════════════════════════════════════════

• Keyword Extraction: Trích xuất các từ quan trọng từ câu hỏi để tìm chunk liên quan
• Min keyword length (Độ dài từ khóa tối thiểu): 2 ký tự
  - File: backend/app/services/rag.py, dòng 1933
  - Ý nghĩa: Từ khóa phải dài hơn 2 ký tự
  - Giải thích: Từ 1-2 ký tự thường không có ý nghĩa (ví dụ: "a", "của")

• Stop words count (Số từ dừng): 11 từ
  - File: backend/app/services/rag.py, dòng 1929
  - Danh sách: {'của', 'và', 'với', 'trong', 'về', 'có', 'là', 'được', 'này', 'cho', 'từ'}
  - Ý nghĩa: Các từ này bị loại bỏ vì quá phổ biến, không có ý nghĩa tìm kiếm
  - Giải thích: Stop words là các từ phổ biến không giúp tìm kiếm (ví dụ: "và", "của")

• Keyword preview in log (Xem trước từ khóa trong log): 10 từ
  - File: backend/app/services/rag.py, dòng 1939
  - Ý nghĩa: Chỉ log 10 từ khóa đầu tiên
  - Giải thích: Không cần log tất cả từ khóa, chỉ cần 10 từ đầu để debug

8. SECTION COVERAGE (Bao phủ phần)
═══════════════════════════════════════════════════════════════════════════════

• Section Coverage: Đảm bảo mỗi phần trong tài liệu đều có đại diện trong kết quả
• Min sections for overview boost (Số phần tối thiểu để tăng cường tổng quan): 3 sections
  - File: backend/app/services/rag.py, dòng 2105
  - Ý nghĩa: Chunk chứa ≥3 "PHẦN X" được boost
  - Giải thích: Chunk chứa nhiều phần (≥3) thường là mục lục hoặc tổng quan → quan trọng

• Section representative (Đại diện phần): 1 chunk per section (1 chunk mỗi phần)
  - File: backend/app/services/rag.py, dòng 2302-2309
  - Ý nghĩa: Mỗi section chọn 1 chunk đại diện (similarity cao nhất)
  - Giải thích: Đảm bảo mỗi phần đều có ít nhất 1 chunk trong kết quả, chọn chunk có độ tương đồng cao nhất

9. DEBUG & MONITORING (Gỡ lỗi và giám sát)
═══════════════════════════════════════════════════════════════════════════════

• Debug (Gỡ lỗi): Kiểm tra và sửa lỗi trong quá trình phát triển
• Monitoring (Giám sát): Theo dõi hoạt động của hệ thống
• Debug chunk indices (Chỉ số chunk để debug): [1, 3, 8, 10, 11]
  - File: backend/app/services/rag.py, dòng 1981, 2386, 2434
  - Ý nghĩa: Chỉ log metadata cho các chunk này khi debug
  - Giải thích: Chỉ log chi tiết cho một số chunk cụ thể để tránh log quá nhiều, dễ kiểm tra

10. API & CONFIGURATION (API và cấu hình)
═══════════════════════════════════════════════════════════════════════════════

• API (Application Programming Interface): Giao diện lập trình ứng dụng
• Configuration (Cấu hình): Các thiết lập của hệ thống
• API port (Cổng API): 8000
  - File: backend/app/core/config.py, dòng 7
  - Ý nghĩa: Server chạy trên cổng 8000
  - Giải thích: URL sẽ là http://localhost:8000

• Access token expire (Thời gian hết hạn token truy cập): 60 phút
  - File: backend/app/core/config.py, dòng 59
  - Ý nghĩa: Token đăng nhập hết hạn sau 60 phút
  - Giải thích: Sau 60 phút, user cần đăng nhập lại

• rag_max_context_length_tokens (Độ dài ngữ cảnh tối đa tính bằng tokens): 8,000 tokens
  - File: backend/app/core/config.py, dòng 30
  - Lưu ý: Không dùng trực tiếp, dùng rag_max_context_length (ký tự) thay thế
  - Giải thích: Cấu hình này không được sử dụng, thay vào đó dùng rag_max_context_length (20,000 ký tự)

═══════════════════════════════════════════════════════════════════════════════
TỔNG KẾT: CÁC CON SỐ QUAN TRỌNG NHẤT CẦN NHỚ
═══════════════════════════════════════════════════════════════════════════════

1. CHUNKING:
   - chunk_size: 800 ký tự
   - chunk_overlap: 100 ký tự
   - split_threshold: 1200 ký tự

2. EMBEDDING:
   - Dimension: 384
   - Batch size: 32

3. DOCUMENT LIMITS:
   - Min: 1 file
   - Max: 5 files

4. MAX CHUNKS PER QUERY:
   - DOCUMENT_OVERVIEW: 150 (1 file), 225 (2 files), 300 (3+ files)
   - SECTION_OVERVIEW: 45 (1 file), 67 (2 files), 90 (3+ files)
   - DIRECT: 15 chunks

5. CONTEXT LENGTH:
   - DOCUMENT_OVERVIEW: 50,000-60,000 ký tự
   - Các loại khác: 12,000 ký tự

6. SIMILARITY THRESHOLDS:
   - DOCUMENT_OVERVIEW: 0.25
   - Các loại khác: 0.4

7. CONFIDENCE THRESHOLDS:
   - Low confidence: 0.3
   - Reasoning query: 0.4
   - DOCUMENT_OVERVIEW: 0.70-0.95
   - DIRECT: 0.90

8. LLM OUTPUT:
   - maxOutputTokens: 12,000 tokens
   - temperature: 0.0

9. REFERENCES:
   - DOCUMENT_OVERVIEW: 10 refs
   - Các loại khác: 5 refs

10. ANSWER LENGTH:
    - Good answer: > 500 ký tự
    - Substantial: ≥ 4000 ký tự
    - Reasoning min: 50 ký tự

═══════════════════════════════════════════════════════════════════════════════

